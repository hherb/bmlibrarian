# The "golden rules" of programming for BMLibrarian

1. **Never trust input from users, external data, network or file data**: Always validate and sanitize input. Never trust that it will be in the expected format or contain the expected data.
2. **No magic numbers**: Always use constants or configuration for numbers. Never hardcode numbers. Always use named constants for numbers that are used in multiple places.
3. **No hardcoded paths**: Always use constants or configuration for paths. Never hardcode paths. Always use named constants for paths that are used in multiple places.
4. **All model communication happens through the python ollama library**: Never use raw HTTP requests to communicate with Ollama. Always use the `ollama` library.
5. **All postgres database communication happens through the database manager**: Never use psycopg connection directly or modify the database structure/schema without proper migration.
6. **All parameters must have type hints**: No exceptions.
7. **All functions, methods, and classes must have docstrings**: No exceptions.
8. **All errors must be handled, logged, and reported to the user**: No exceptions.
9. **No inline style sheets**: All stylesheets must be generated by the stylesheet generator / centralised styling system (stylesheet_generator.py).
10. **No hardcoded pixel values**: All dimensions must be calculated from font metrics or relative to other elements, generally using our dpi font scaling system (dpi_scale.py).
11. **We prefer reusable pure functions over more complex larger structures.** Where possible, such pure functions should be factored out into generally useful libraries.
12. **All modules need to be documented in markdown format** in doc/users for the end user, and doc/developers for developers. Important information for the AI assistant goes into doc/llm.
13. **All tests must be written**: No exceptions.
14. **No truncation of data**: Never truncate data unless explicitly specified by the user. NEVER introduce truncation before consulting with the team and getting approval.
15. **All database migrations MUST be idempotent**: Use `CREATE TABLE IF NOT EXISTS`, `CREATE INDEX IF NOT EXISTS`, `DO $$ ... IF NOT EXISTS ... END $$` blocks for ALTER TABLE. Migrations must be safe to run multiple times without errors or data loss.
16. **Migration files must NOT contain their own tracking code**: The `MigrationManager` handles migration tracking via the `bmlibrarian_migrations` table. Never create or insert into `public.schema_migrations` or similar tables inside migration files.
17. **NEVER modify production database without explicit permission**: Use the development database for testing migrations. Production changes require team approval.
18. **Use `get_document_details()` for fetching document metadata**: When loading documents in widgets/components, always use the canonical `get_document_details(document_id)` function from `bmlibrarian.database`. This ensures consistent field names, pre-formatted authors, and proper PMID extraction across all UI components. Never write inline SQL for document fetching in UI code.
19. **Use `FONT_FAMILY` constant for font-family in stylesheets**: Never hardcode font names like 'Segoe UI'. Import `FONT_FAMILY` from `bmlibrarian.gui.qt.resources.styles` which provides cross-platform font fallbacks (macOS: system fonts, Windows: Segoe UI, Linux: Ubuntu/DejaVu).
